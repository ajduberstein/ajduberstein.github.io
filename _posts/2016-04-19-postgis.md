---
layout: page
title : "Space Exploration"
category : "Tools of the Trade"
tagline: "How to Use PostGIS for analyzing millions of points from the comfort of your laptop"
image: https://upload.wikimedia.org/wikipedia/commons/thumb/4/41/Countries_and_Dependencies_by_Population_in_2014.svg/500px-Countries_and_Dependencies_by_Population_in_2014.svg.png
tags : [ Postgres]
---
{% include JB/setup %}

*Assumptions: You've installed a Postgres installation (I like [postgres.app](http://postgresapp.com/)) and know ANSI SQL to mastery.*

I've yet to find a tool that trumps PostgreSQL for a few million points of geospatial analysis. Let's discuss its features and idiosyncracies.

#### Creating your own database

Open Postgres (If you're using postgres.app, open that up and press `open psql`). Type

`createdb test`

This created a Postgres database called test. To enter that database, type from a command line (like Terminal on Mac)
`psql test` or `psql -d test`, which very explicitly tells Postgres, "Use the database named *test*." If you have a SQL file (let's say it's name is `foobar.sql`) you want to execute against this database, you'd type `psql -f foobar.sql -d test`.

#### Activating PostGIS and Loading Your Own Data
At the `psql` prompt, type `CREATE EXTENSION postgis`. If no error is displayed, your machine is readied for geospatial analysis.

*Input*: To load a table from a CSV to the interactive psql prompt, type `\copy tablename FROM '/path/for/desired/copying/filename.csv' HEADER CSV`. 
*Output*: To copy a table to a CSV file from the interactive psql prompt, type `\copy tablename TO '/path/for/desired/copying/filename.csv' HEADER CSV`. 
If you don't have/want a header, remove the word `HEADER`.

#### Working with Geometries
Suppose you have a lat-lon point you want to convert to a shape. Load your CSV as demonstrated above, and then type:

```
ALTER TABLE table_name ADD geom GEOMETRY;
UPDATE table_name SET geom = st_setsrid(st_point(lng_field,lat_field),4326);
```

The lines, in order, do this:

- Add a column to our table named geom and give it the type GEOMETRY
- Populate that column with a point created from the lat-lon fields, and let PostGIS know that the point is a geocoordinate measured in degrees (the magic number 4326 does this; other values exist for different units of measure).
If you're planning on doing a JOIN to a shape, create an index:

```
CREATE INDEX ON table_name USING gist(geom);
```

Suppose you've got a shapefile (.shp) you're trying to load in the database. The easiest way to do this is to type in the terminal:

```
shp2pgsql -s file_name.shp desired_table_name | psql db_name
```

#### Useful functions for geospatial data

`ST_Contains` — Returns true if and only if no points of B lie in the exterior of A, and at least one point of the interior of B lies in the interior of A.
`ST_ContainsProperly` — Returns true if B intersects the interior of A but not the boundary (or exterior). A does not contain properly itself, but does contain itself.
`ST_Covers` — Returns 1 (TRUE) if no point in Geometry B is outside Geometry A
`ST_CoveredBy` — Returns 1 (TRUE) if no point in Geometry/Geography A is outside Geometry/Geography B
`ST_Crosses` — Returns TRUE if the supplied geometries have some, but not all, interior points in common.

